<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <style>
        button {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h3>DynamicsWebApi Promises</h3>
    <button onclick="CreateRecord()">Create Record</button>
    <button onclick="UpdateRecord()">Update Record</button>
    <button onclick="UpdateSingleProperty()">Update Single Property</button>
    <button onclick="RetrieveRecord()">Retrieve Record</button>
    <button onclick="CountRecords()">Count Records</button>
    <button onclick="DeleteRecord()">Delete Record</button>
    <button onclick="UpsertRecord()">Upsert Record</button>
    <button onclick="RetrieveMultipleRecordsExtended()">Multiple Records Extended</button>
    <button onclick="FetchXmlTest()">Fetch XML Test</button>
    <button onclick="Associate()">Associate</button>
    <button onclick="AssociateSingleValued()">Associate Single Valued</button>
    <button onclick="Disassociate()">Disassociate</button>
    <button onclick="TestAnotherInstance()">Another instance test</button>

    <script src="../../clientGlobalcontext.js.aspx"></script>
    <script src="../Scripts/DynamicsWebApi.js"></script>
    <script>
        var recordId = "115a8970-d788-4bf6-b064-d1574dbe6930";
        dynamicsWebApi.setConfig({ webApiVersion: "8.2" });
        var accountId = null;
        var testEntityid = null;

        //for association
        dynamicsWebApi.retrieveMultiple("accounts", ["accountid"], "name eq 'Best For You Organics Company'").then(function (response) {
            /// <param name="response" type="DWA.Types.MultipleResponse">Response object</param>
            accountId = response.value[0].accountid;
        }).catch(function (error) {
            debugger;
        });
        dynamicsWebApi.createRequest({ o4u_name: "Test" }, "o4u_tests").then(function (id) {
            testEntityid = id;
        }).catch(function (error) {
            debugger;
        });

        function CreateRecord() {
            var lead = {
                subject: "Test WebAPI",
                firstname: "Test",
                lastname: "WebAPI",
                jobtitle: "Title"
            };
            dynamicsWebApi.createRequest(lead, "leads").then(function (id) {
                alert(id);
                recordId = id;
            }).catch(function (error) {
                debugger;
            });
        }
        function RetrieveRecord() {
            dynamicsWebApi.retrieveRecord(recordId, "leads", ["fullname", "subject"], null).then(function (object) {
                var fullname = object.fullname;
                debugger;
            })
            .catch(function (error) {
                //if the record has not been found it will throw an error
                debugger;
                console.trace(error.message);
            });
        }
        function CountRecords() {
            dynamicsWebApi.countRecords("leads", "statecode eq 0").then(function (count) {
                alert(count);
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function RetrieveMultipleRecordsExtended() {
            var request = {
                collectionName: "leads",
                select: ["fullname", "subject"],
                filter: "leadid eq " + recordId,
                maxPageSize: 1
            };

            dynamicsWebApi.retrieveMultipleAdvanced(request).then(function (response) {
                /// <param name="response" type="DWA.Types.MultipleResponse">Request response</param>

                //get a field value here (check first whether object (array) contains any element)
                var fullname = response.value.length ? response.value[0].fullname : "-1";
                debugger;
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function DeleteRecord() {
            dynamicsWebApi.deleteRequest(recordId, "leads").then(function () {
                alert("success!");
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpdateRecord() {
            var lead = {
                subject: "Test update"
            }

            dynamicsWebApi.updateRequest(recordId, "leads", lead).then(function () {
                alert("updated!");
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpsertRecord() {
            var lead = {
                subject: "Upsert!!"
            };

            dynamicsWebApi.upsertRequest(recordId, "leads", lead, "*").then(function (id) {
                if (id != null) {
                    recordId = id;
                }
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpdateSingleProperty() {
            dynamicsWebApi.updateSingleProperty(recordId, "leadsS", { subject: "Update Single" }).then(function () {
                alert("success!");
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function FetchXmlTest() {
            var fetchXml = "<fetch mapping='logical'>" +
                               "<entity name='account'>" +
                                  "<attribute name='accountid'/>" +
                                  "<attribute name='name'/>" +
                                "</entity>" +
                            "</fetch>";

            dynamicsWebApi.fetchXmlRequest("accounts", fetchXml).then(function (response) {
                /// <param name="response" type="DWA.Types.FetchXmlResponse">Request response</param>

                for (var i = 0; i < response.value.length; i++) {
                    console.trace("accountid: " + response.value[i].accountid + ", name: " + response.value[i].name);
                }
                debugger;
            })
            .catch(function (error) {
                debugger;
                console.trace(error.message);
            })
        }
        function Associate() {
            dynamicsWebApi.associateRequest("accounts", accountId, "lead_parent_account", "leads", recordId).then(function () {
                alert("success!");
            }).catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function Disassociate() {
            dynamicsWebApi.disassociateRequest("accounts", accountId, "lead_parent_account", recordId).then(function () {
                alert("success!");
            }).catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function AssociateSingleValued() {
            dynamicsWebApi.associateSingleValuedRequest("o4u_tests", testEntityid, "o4u_lead_o4u_test_LeadTest", "leads", recordId).then(function () {
                alert("success!");
            }).catch(function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function TestAnotherInstance() {

            var instance = dynamicsWebApi.initializeInstance({ webApiVersion: "8.0" });

            instance.countRecords("accounts").then(function (count) {
                alert(count);
            }).catch(function (error) {
                debugger;
                console.trace(error.message);
            })
        }
    </script>
</body>

</html>
